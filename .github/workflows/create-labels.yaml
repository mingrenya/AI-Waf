name: "ğŸ·ï¸ Initialize Repository Labels"

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘

permissions:
  issues: write
  contents: read

jobs:
  create-labels:
    name: "Create Essential Labels"
    runs-on: ubuntu-latest

    steps:
      - name: "ğŸ·ï¸ Create and Report Labels"
        uses: actions/github-script@v7
        with:
          script: |
            // ğŸ¯ ç®€åŒ–æ ‡ç­¾ä½“ç³» - ä»…20ä¸ªå®ç”¨æ ‡ç­¾
            const labels = [
              // ======== æ ¸å¿ƒé¢†åŸŸæ ‡ç­¾ (8ä¸ª) ========
              { name: 'area/frontend', color: '28a745', description: 'å‰ç«¯ä»£ç  (web/, *.tsx, *.vue, *.css)' },
              { name: 'area/backend', color: 'd73a4a', description: 'åç«¯ä»£ç  (server/, *.go)' },
              { name: 'area/docs', color: '0366d6', description: 'æ–‡æ¡£æ›´æ–° (*.md, docs/)' },
              { name: 'area/config', color: '1f883d', description: 'é…ç½®æ–‡ä»¶ (*.yml, *.json, docker)' },
              { name: 'area/ci', color: '6f42c1', description: 'CI/CDç›¸å…³ (.github/, scripts/)' },
              { name: 'area/test', color: 'ff6b35', description: 'æµ‹è¯•ä»£ç  (*_test.go, *.test.*)' },
              { name: 'area/security', color: 'f39c12', description: 'WAFå¼•æ“å’Œå®‰å…¨ (coraza-spoa/, security/)' },
              { name: 'area/deps', color: 'e1e4e8', description: 'ä¾èµ–ç®¡ç† (go.mod, package.json)' },
              
              // ======== ç±»å‹æ ‡ç­¾ (6ä¸ª) ========
              { name: 'type/feat', color: '28a745', description: 'âœ¨ æ–°åŠŸèƒ½' },
              { name: 'type/fix', color: 'd73a4a', description: 'ğŸ› é”™è¯¯ä¿®å¤' },
              { name: 'type/docs', color: '0366d6', description: 'ğŸ“š æ–‡æ¡£æ›´æ–°' },
              { name: 'type/refactor', color: '6f42c1', description: 'â™»ï¸ ä»£ç é‡æ„' },
              { name: 'type/test', color: 'ff6b35', description: 'ğŸ§ª æµ‹è¯•ç›¸å…³' },
              { name: 'type/chore', color: 'e1e4e8', description: 'ğŸ”§ æ‚é¡¹/æ„å»º' },
              
              // ======== ä¼˜å…ˆçº§æ ‡ç­¾ (3ä¸ª) ========
              { name: 'priority/high', color: 'd93f0b', description: 'ğŸ”¥ é«˜ä¼˜å…ˆçº§' },
              { name: 'priority/medium', color: 'fbca04', description: 'âš¡ ä¸­ç­‰ä¼˜å…ˆçº§' },
              { name: 'priority/low', color: '0e8a16', description: 'ğŸŒ± ä½ä¼˜å…ˆçº§' },
              
              // ======== çŠ¶æ€æ ‡ç­¾ (3ä¸ª) ========
              { name: 'status/needs-review', color: 'ff9500', description: 'ğŸ‘€ éœ€è¦ä»£ç å®¡æŸ¥' },
              { name: 'status/ready-to-merge', color: '28a745', description: 'âœ… å‡†å¤‡åˆå¹¶' },
              { name: 'status/blocked', color: 'd73a4a', description: 'ğŸš« è¢«é˜»å¡' }
            ];

            console.log(`ğŸ¯ åˆ›å»ºç®€åŒ–æ ‡ç­¾ä½“ç³» (${labels.length} ä¸ªæ ‡ç­¾)`);
            let created = 0;
            let updated = 0;
            let failed = 0;

            for (const label of labels) {
              try {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name,
                  color: label.color,
                  description: label.description
                });
                console.log(`âœ… åˆ›å»ºæ ‡ç­¾: ${label.name}`);
                created++;
              } catch (error) {
                if (error.status === 422) {
                  try {
                    await github.rest.issues.updateLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: label.name,
                      color: label.color,
                      description: label.description
                    });
                    console.log(`ğŸ”„ æ›´æ–°æ ‡ç­¾: ${label.name}`);
                    updated++;
                  } catch (updateError) {
                    console.log(`âŒ æ›´æ–°æ ‡ç­¾å¤±è´¥: ${label.name}`);
                    failed++;
                  }
                } else {
                  console.log(`âŒ åˆ›å»ºæ ‡ç­¾å¤±è´¥: ${label.name}`);
                  failed++;
                }
              }
            }

            console.log(`\nğŸ‰ å®Œæˆï¼æ–°å»º:${created} | æ›´æ–°:${updated} | å¤±è´¥:${failed}`);

            // ğŸ”§ ä¿®å¤ï¼šç›´æ¥åœ¨è„šæœ¬ä¸­ç”Ÿæˆæ‘˜è¦ï¼Œé¿å…æ­¥éª¤é—´ä¼ é€’å˜é‡
            await core.summary
              .addHeading('ğŸ·ï¸ ç®€åŒ–æ ‡ç­¾ä½“ç³»åˆ›å»ºå®Œæˆ', 2)
              .addRaw('âœ… **å·²åˆ›å»ºç²¾ç®€å®ç”¨çš„æ ‡ç­¾ä½“ç³» (ä»…20ä¸ªæ ‡ç­¾)ï¼**\n\n')
              .addHeading('ğŸ“ˆ ç»Ÿè®¡ç»“æœ', 3)
              .addTable([
                [
                  { data: 'é¡¹ç›®', header: true },
                  { data: 'æ•°é‡', header: true }
                ],
                ['ğŸ†• æ–°å»ºæ ‡ç­¾', `**${created}**`],
                ['ğŸ”„ æ›´æ–°æ ‡ç­¾', `**${updated}**`],
                ['âŒ å¤±è´¥æ ‡ç­¾', `**${failed}**`],
                ['ğŸ“Š æ€»è®¡', `**${labels.length}** ä¸ªæ ‡ç­¾`]
              ])
              .addHeading('ğŸ¯ æ ‡ç­¾åˆ†ç±»', 3)
              .addTable([
                [
                  { data: 'ç±»åˆ«', header: true },
                  { data: 'æ•°é‡', header: true },
                  { data: 'è¯´æ˜', header: true }
                ],
                ['ğŸ“ **é¢†åŸŸæ ‡ç­¾**', '8ä¸ª', 'è‡ªåŠ¨æ ¹æ®æ–‡ä»¶è·¯å¾„æ·»åŠ '],
                ['ğŸ·ï¸ **ç±»å‹æ ‡ç­¾**', '6ä¸ª', 'æ‰‹åŠ¨æ·»åŠ (feat/fix/docsç­‰)'],
                ['ğŸš¨ **ä¼˜å…ˆçº§**', '3ä¸ª', 'æ‰‹åŠ¨æ·»åŠ (high/medium/low)'],
                ['ğŸ¯ **çŠ¶æ€**', '3ä¸ª', 'æ‰‹åŠ¨æ·»åŠ (review/ready/blocked)']
              ])
              .addHeading('ğŸš€ æ¥ä¸‹æ¥çš„æ“ä½œ', 3)
              .addList([
                `ğŸ” è®¿é—® [æ ‡ç­¾é¡µé¢](https://github.com/${context.repo.owner}/${context.repo.repo}/labels) æŸ¥çœ‹æ–°æ ‡ç­¾`,
                'ğŸ§ª ä¿®æ”¹ `web/` æˆ– `server/` ç›®å½•æ–‡ä»¶å¹¶åˆ›å»ºPRæµ‹è¯•è‡ªåŠ¨æ ‡ç­¾',
                'âœ‹ æ‰‹åŠ¨ä¸ºPRæ·»åŠ  `type/`ã€`priority/`ã€`status/` æ ‡ç­¾'
              ])
              .addHeading('ğŸ’¡ æ ‡ç­¾ä½¿ç”¨æŒ‡å—', 3)
              .addRaw('**ğŸ¤– è‡ªåŠ¨æ ‡ç­¾**: æ ¹æ®æ–‡ä»¶è·¯å¾„è‡ªåŠ¨æ·»åŠ \n')
              .addList([
                'ä¿®æ”¹ `web/` â†’ `area/frontend`',
                'ä¿®æ”¹ `server/` â†’ `area/backend`',
                'ä¿®æ”¹ `*.md` â†’ `area/docs`'
              ])
              .addRaw('\n**âœ‹ æ‰‹åŠ¨æ ‡ç­¾**: å»ºè®®æ·»åŠ \n')
              .addList([
                '**ç±»å‹**: `type/feat`, `type/fix`, `type/docs`',
                '**ä¼˜å…ˆçº§**: `priority/high`, `priority/medium`, `priority/low`',
                '**çŠ¶æ€**: `status/needs-review`, `status/ready-to-merge`'
              ])
              .write();

            console.log('ğŸ“Š æ‘˜è¦æŠ¥å‘Šå·²ç”Ÿæˆ');
            return 'ğŸ‰ æ ‡ç­¾åˆ›å»ºå®Œæˆï¼';
