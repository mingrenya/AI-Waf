name: Docker Build and Push

# ğŸ”’ å·¥ä½œæµçº§æƒé™æ§åˆ¶
permissions:
  contents: read
  packages: write
  pull-requests: write

on:
  # PR æäº¤æˆ–æ›´æ–°æ—¶è§¦å‘ï¼ˆç”¨äºæ„å»ºæ£€æŸ¥ï¼‰
  pull_request:
    branches: [main, master, develop]
    types: [opened, synchronize, reopened]

  # ä¸“é—¨ç”¨äº PR è¯„è®ºçš„è§¦å‘å™¨ï¼ˆæ”¯æŒ fork ä»“åº“ï¼‰
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]

  # åˆå¹¶åˆ°ä¸»åˆ†æ”¯æ—¶è§¦å‘
  push:
    branches: [main, master]

  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

env:
  # ä½¿ç”¨ vars è€Œä¸æ˜¯ secrets æ¥å­˜å‚¨ç”¨æˆ·åï¼ˆæ¨èåšæ³•ï¼‰
  DOCKER_IMAGE: ${{ vars.DOCKERHUB_USERNAME && vars.DOCKERHUB_USERNAME != '' && vars.DOCKERHUB_USERNAME || 'defaultuser' }}/ruiqi-waf

jobs:
  # ä¸»è¦çš„æ„å»ºæ£€æŸ¥ jobï¼ˆä½¿ç”¨ pull_requestï¼Œå®‰å…¨æ‰§è¡Œå¤–éƒ¨ä»£ç ï¼‰
  docker-build:
    name: Docker Build Check
    runs-on: ubuntu-latest
    # åªåœ¨ pull_request å’Œ push äº‹ä»¶æ—¶è¿è¡Œï¼Œä¸åœ¨ pull_request_target æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request_target'

    outputs:
      build-status: ${{ steps.set-status.outputs.build_status }}
      build-result: ${{ steps.set-status.outputs.build_result }}
      image-tags: ${{ steps.meta.outputs.tags }}
      build-time: ${{ steps.set-status.outputs.build_time }}
      commit-sha: ${{ steps.set-status.outputs.commit_sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # æ™ºèƒ½è®¾ç½®ï¼šPRåªéœ€è¦QEMUç”¨äºARM64ï¼Œæ¨é€æ—¶æ‰è®¾ç½®
      - name: Set up QEMU
        if: github.event_name == 'push'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ä»…æ¨é€æ—¶ç™»å½•Docker Hub
      - name: Login to Docker Hub
        if: github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # æ€»æ˜¯ç™»å½•GitHub Container Registryï¼ˆæ›´å¿«ï¼‰
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ç”Ÿæˆæ ‡ç­¾
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ env.DOCKER_IMAGE }}
            ghcr.io/${{ github.repository }}
          tags: |
            type=ref,event=pr
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=latest,enable={{is_default_branch}}

      # åˆ›å»ºå¤šå¹³å°Dockerfileï¼ˆä»…åœ¨éœ€è¦æ—¶ï¼‰
      - name: Prepare multi-platform Dockerfile
        if: github.event_name == 'push'
        run: |
          sed 's/GOOS=linux/GOOS=$TARGETOS/g; s/GOARCH=amd64/GOARCH=$TARGETARCH/g' Dockerfile > Dockerfile.multiarch

      # PRé˜¶æ®µï¼šä»…æ„å»ºAMD64è¿›è¡Œå¿«é€ŸéªŒè¯
      - name: Build Docker image (PR - AMD64 only)
        if: github.event_name == 'pull_request'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64
          push: false
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=pr-amd64
          cache-to: type=gha,mode=max,scope=pr-amd64
          # PRé˜¶æ®µä¼˜åŒ–ï¼šç¦ç”¨ä¸å¿…è¦çš„åŠŸèƒ½
          provenance: false
          sbom: false
        continue-on-error: true

      # æ¨é€é˜¶æ®µï¼šå®Œæ•´å¤šå¹³å°æ„å»º
      - name: Build and push (Multi-platform)
        if: github.event_name == 'push'
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.multiarch
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha,scope=build-amd64
            type=gha,scope=build-arm64
          cache-to: type=gha,mode=max,scope=build-multiplatform
          # ç”Ÿäº§æ„å»ºï¼šå¯ç”¨å®Œæ•´å®‰å…¨åŠŸèƒ½
          provenance: true
          sbom: true

      # ğŸ“¤ è®¾ç½®è¾“å‡ºçŠ¶æ€
      - name: Set job outputs
        id: set-status
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "build_status=success" >> $GITHUB_OUTPUT
            echo "build_result=passed" >> $GITHUB_OUTPUT
          else
            echo "build_status=failure" >> $GITHUB_OUTPUT
            echo "build_result=failed" >> $GITHUB_OUTPUT
          fi
          echo "build_time=$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
          echo "commit_sha=${{ github.sha }}" >> $GITHUB_OUTPUT

      # ç”Ÿæˆè¯¦ç»†æ„å»ºæŠ¥å‘Š
      - name: Generate Docker build summary
        if: always()
        run: |
          echo "## ğŸš€ Docker Build Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ„å»ºçŠ¶æ€
          echo "### ğŸ“‹ Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|---------|" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" = "success" ]; then
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              echo "| Docker Build | âœ… Passed | AMD64 architecture verification successful |" >> $GITHUB_STEP_SUMMARY
              echo "| Platform | ğŸ“± Single | linux/amd64 (PR optimization) |" >> $GITHUB_STEP_SUMMARY
              echo "| Cache | ğŸš€ Optimized | GitHub Actions cache enabled |" >> $GITHUB_STEP_SUMMARY
            else
              echo "| Docker Build | âœ… Passed | Multi-platform build successful |" >> $GITHUB_STEP_SUMMARY
              echo "| Platform | ğŸŒ Multi | linux/amd64, linux/arm64 |" >> $GITHUB_STEP_SUMMARY
              echo "| Registry Push | âœ… Completed | Docker Hub + GitHub Container Registry |" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "| Docker Build | âŒ Failed | Please check build logs |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Build Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Event Type**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ğŸ”’ å®‰å…¨çš„ PR è¯„è®º jobï¼ˆä½¿ç”¨ pull_request_targetï¼Œä½†ä¸ checkout å¤–éƒ¨ä»£ç ï¼‰
  pr-comment:
    name: PR Comment Handler
    runs-on: ubuntu-latest
    # åªåœ¨ pull_request_target äº‹ä»¶æ—¶è¿è¡Œ
    if: github.event_name == 'pull_request_target'

    steps:
      # ğŸ”’ é‡è¦ï¼šä¸ checkout ä»»ä½•ä»£ç ï¼Œç‰¹åˆ«æ˜¯ PR ä»£ç ï¼
      # ğŸ”’ åªä½¿ç”¨ GitHub API è·å–å·¥ä½œæµè¿è¡Œç»“æœ

      - name: Wait for main build to complete
        uses: actions/github-script@v7
        id: wait-for-build
        with:
          script: |
            const { owner, repo } = context.repo;
            const headSha = context.payload.pull_request.head.sha;

            console.log(`ç­‰å¾… commit ${headSha} çš„æ„å»ºå®Œæˆ...`);

            // ç­‰å¾…æœ€å¤š 15 åˆ†é’Ÿï¼ˆDocker æ„å»ºå¯èƒ½è¾ƒé•¿ï¼‰
            const maxWaitTime = 15 * 60 * 1000; // 15 minutes
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
              try {
                // è·å– commit çš„æ‰€æœ‰ check runs
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner,
                  repo,
                  ref: headSha,
                });
                
                // æŸ¥æ‰¾æˆ‘ä»¬çš„Dockeræ„å»ºå·¥ä½œæµ
                const dockerCheck = checkRuns.check_runs.find(run => 
                  run.name === 'Docker Build Check'
                );
                
                if (dockerCheck) {
                  console.log(`å‘ç°æ„å»º: ${dockerCheck.name}, çŠ¶æ€: ${dockerCheck.status}`);
                  
                  if (dockerCheck.status === 'completed') {
                    console.log(`æ„å»ºå®Œæˆï¼Œç»“è®º: ${dockerCheck.conclusion}`);
                    return {
                      completed: true,
                      conclusion: dockerCheck.conclusion,
                      details_url: dockerCheck.details_url
                    };
                  }
                }
                
                // ç­‰å¾… 30 ç§’åé‡è¯•
                await new Promise(resolve => setTimeout(resolve, 30000));
              } catch (error) {
                console.log(`è·å–æ„å»ºçŠ¶æ€æ—¶å‡ºé”™: ${error.message}`);
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
            }

            // è¶…æ—¶æƒ…å†µ
            console.log('ç­‰å¾…è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            return {
              completed: false,
              conclusion: 'timed_out',
              details_url: null
            };

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const buildResult = ${{ steps.wait-for-build.outputs.result }};
            const prNumber = context.payload.pull_request.number;
            const buildTime = new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' });

            let emoji, statusEn, statusCn, conclusion;

            if (!buildResult.completed) {
              emoji = 'â°';
              statusEn = 'In Progress';
              statusCn = 'è¿›è¡Œä¸­';
              conclusion = 'pending';
            } else {
              switch(buildResult.conclusion) {
                case 'success':
                  emoji = 'âœ…';
                  statusEn = 'Success';
                  statusCn = 'æˆåŠŸ';
                  conclusion = 'success';
                  break;
                case 'failure':
                  emoji = 'âŒ';
                  statusEn = 'Failed';
                  statusCn = 'å¤±è´¥';
                  conclusion = 'failure';
                  break;
                default:
                  emoji = 'âš ï¸';
                  statusEn = 'Unknown';
                  statusCn = 'æœªçŸ¥';
                  conclusion = 'neutral';
              }
            }

            // æ„å»ºä¸­æ–‡æŠ¥å‘Š
            let chineseReport = `### ä¸­æ–‡æŠ¥å‘Š\n\n`;

            if (!buildResult.completed) {
              chineseReport += `**â° çŠ¶æ€:** Docker æ„å»ºæ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™æŸ¥çœ‹ç»“æœã€‚`;
            } else if (buildResult.conclusion === 'success') {
              chineseReport += `**ğŸ‰ ç»“æœ:** Docker æ„å»ºéªŒè¯é€šè¿‡ï¼é•œåƒæ„å»ºæˆåŠŸã€‚\n\n`;
              chineseReport += `**ğŸ—ï¸ æ„å»ºè¯¦æƒ…:**\n`;
              chineseReport += `- âœ… éªŒè¯å¹³å°: \`linux/amd64\`\n`;
              chineseReport += `- âœ… æ„å»ºçŠ¶æ€: ${statusCn}\n`;
              chineseReport += `- âœ… ç¼“å­˜ä¼˜åŒ–: GitHub Actions ç¼“å­˜å·²å¯ç”¨\n`;
              chineseReport += `- âœ… æäº¤: \`${context.payload.pull_request.head.sha}\`\n`;
              chineseReport += `- âœ… æ„å»ºæ—¶é—´: ${buildTime}\n\n`;
              chineseReport += `**ğŸ’¡ ä¼˜åŒ–è¯´æ˜:** PR é˜¶æ®µä»…æ„å»º AMD64 ä»¥æé«˜é€Ÿåº¦ï¼Œå®Œæ•´çš„å¤šå¹³å°æ„å»ºå°†åœ¨åˆå¹¶åè¿›è¡Œã€‚`;
            } else if (buildResult.conclusion === 'failure') {
              chineseReport += `**âš ï¸ éœ€è¦å…³æ³¨:** Docker æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚\n\n`;
              chineseReport += `**ğŸ”§ å¸¸è§è§£å†³æ–¹æ¡ˆ:**\n`;
              chineseReport += `- æ£€æŸ¥ Dockerfile è¯­æ³•\n`;
              chineseReport += `- ç¡®è®¤ä¾èµ–åŒ…ç‰ˆæœ¬\n`;
              chineseReport += `- éªŒè¯æ„å»ºä¸Šä¸‹æ–‡è·¯å¾„\n\n`;
              chineseReport += `ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†æ„å»ºæ—¥å¿—ã€‚`;
            } else {
              chineseReport += `**â„¹ï¸ çŠ¶æ€:** æ„å»ºçŠ¶æ€å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥å·¥ä½œæµé…ç½®ã€‚`;
            }

            // æ„å»ºè‹±æ–‡æŠ¥å‘Š
            let englishReport = `### English Report\n\n`;

            if (!buildResult.completed) {
              englishReport += `**â° Status:** Docker build is in progress, please wait for results.`;
            } else if (buildResult.conclusion === 'success') {
              englishReport += `**ğŸ‰ Result:** Docker build verification passed! Image build successful.\n\n`;
              englishReport += `**ğŸ—ï¸ Build Details:**\n`;
              englishReport += `- âœ… Verification Platform: \`linux/amd64\`\n`;
              englishReport += `- âœ… Build Status: ${statusEn}\n`;
              englishReport += `- âœ… Cache Optimization: GitHub Actions cache enabled\n`;
              englishReport += `- âœ… Commit: \`${context.payload.pull_request.head.sha}\`\n`;
              englishReport += `- âœ… Build Time: ${buildTime}\n\n`;
              englishReport += `**ğŸ’¡ Optimization Note:** PR stage only builds AMD64 to improve speed, complete multi-platform build will be performed after merge.`;
            } else if (buildResult.conclusion === 'failure') {
              englishReport += `**âš ï¸ Attention Required:** Docker build failed, please check detailed logs.\n\n`;
              englishReport += `**ğŸ”§ Common Solutions:**\n`;
              englishReport += `- Check Dockerfile syntax\n`;
              englishReport += `- Verify dependency versions\n`;
              englishReport += `- Validate build context path\n\n`;
              englishReport += `Click the link below to view detailed build logs.`;
            } else {
              englishReport += `**â„¹ï¸ Status:** Build status is abnormal, please check workflow configuration.`;
            }

            // ç»„åˆæœ€ç»ˆå†…å®¹
            let body = `## ğŸš€ Docker Quick Build ${statusEn} ${emoji}\n\n`;
            body += `**PR #${prNumber}** AMD64 platform verification completed (optimized for faster verification)\n\n`;
            body += `${chineseReport}\n\n---\n\n${englishReport}`;

            // å¦‚æœæœ‰è¯¦ç»†é“¾æ¥ï¼Œæ·»åŠ åˆ°æŠ¥å‘Šä¸­
            if (buildResult.details_url) {
              body += `\n\n**ğŸ”— æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ / View Details:** [ç‚¹å‡»æŸ¥çœ‹å®Œæ•´æ„å»ºç»“æœ / Click here to see full build results](${buildResult.details_url})`;
            }

            // æŸ¥æ‰¾å¹¶æ›´æ–°ç°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸš€ Docker Quick Build')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('å·²æ›´æ–°ç°æœ‰çš„ PR è¯„è®º');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('å·²åˆ›å»ºæ–°çš„ PR è¯„è®º');
            }
