# .github/workflows/go-quality-check.yml (å®‰å…¨ä¿®å¤ç‰ˆæœ¬)
name: Go Code Quality Check

# ğŸ”’ å·¥ä½œæµçº§æƒé™æ§åˆ¶
permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

on:
  pull_request:
    branches: [main, master, develop]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "server/**"
      - "pkg/**"
      - "coraza-spoa/**"
      - "go.work"
  # ä¸“é—¨ç”¨äº PR è¯„è®ºçš„è§¦å‘å™¨
  pull_request_target:
    types: [opened, synchronize, reopened]
    branches: [main, master, develop]
  push:
    branches: [main, master, develop]
    paths:
      - "**/*.go"
      - "go.mod"
      - "go.sum"
      - "server/**"
      - "pkg/**"
      - "coraza-spoa/**"
      - "go.work"
  workflow_dispatch:

jobs:
  # ä¸»è¦çš„ CI æ£€æŸ¥ jobï¼ˆä½¿ç”¨ pull_requestï¼Œå®‰å…¨æ‰§è¡Œå¤–éƒ¨ä»£ç ï¼‰
  go-check:
    name: Go Code Quality Check
    runs-on: ubuntu-latest
    # åªåœ¨ pull_request å’Œ push äº‹ä»¶æ—¶è¿è¡Œï¼Œä¸åœ¨ pull_request_target æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request_target'

    outputs:
      format-issues: ${{ steps.set-status.outputs.format_issues }}
      format-files: ${{ steps.set-status.outputs.format_files }}
      style-suggestions-found: ${{ steps.set-status.outputs.style_suggestions_found }}
      style-suggestions-count: ${{ steps.set-status.outputs.style_suggestions_count }}
      style-suggestions: ${{ steps.set-status.outputs.style_suggestions }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24.1"

      # ç¼“å­˜ Go æ¨¡å—
      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # æ£€æŸ¥ Go ä»£ç æ ¼å¼
      - name: Check Go formatting
        run: |
          echo "ğŸ” æ£€æŸ¥ Go ä»£ç æ ¼å¼..."
          unformatted=$(gofmt -l .)
          if [ ! -z "$unformatted" ]; then
            echo "âš ï¸ ä»¥ä¸‹æ–‡ä»¶æ ¼å¼éœ€è¦ä¼˜åŒ–ï¼š"
            echo "$unformatted"
            echo ""
            echo "ğŸ’¡ å»ºè®®è¿è¡Œ 'gofmt -w .' æ¥æ ¼å¼åŒ–ä»£ç "
            echo "FORMAT_ISSUES=true" >> $GITHUB_ENV
            echo "FORMAT_FILES<<EOF" >> $GITHUB_ENV
            echo "$unformatted" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "âœ… Go ä»£ç æ ¼å¼æ­£ç¡®"
            echo "FORMAT_ISSUES=false" >> $GITHUB_ENV
            echo "FORMAT_FILES=" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # è¿è¡Œ go vet
      - name: Run go vet
        run: |
          echo "ğŸ” è¿è¡Œ go vet..."
          failed=false

          if [ -d "server" ]; then
            echo "æ£€æŸ¥ server æ¨¡å—..."
            cd server && go vet ./... || failed=true
            cd ..
          fi

          if [ -d "pkg" ]; then
            echo "æ£€æŸ¥ pkg æ¨¡å—..."
            cd pkg && go vet ./... || failed=true
            cd ..
          fi

          if [ -d "coraza-spoa" ]; then
            echo "æ£€æŸ¥ coraza-spoa æ¨¡å—..."
            cd coraza-spoa && go vet ./... || failed=true
            cd ..
          fi

          if [ "$failed" = "true" ]; then
            echo "âŒ go vet å‘ç°é‡è¦é—®é¢˜"
            exit 1
          fi
          echo "âœ… go vet æ£€æŸ¥é€šè¿‡"

      # è¿è¡Œ staticcheckï¼ˆæ ¸å¿ƒæ£€æŸ¥ + è¯¦ç»†é£æ ¼å»ºè®®ï¼‰
      - name: Run staticcheck
        run: |
          go install honnef.co/go/tools/cmd/staticcheck@latest
          echo "ğŸ” è¿è¡Œ staticcheck..."

          # æ ¸å¿ƒæ£€æŸ¥ï¼ˆbugã€æ€§èƒ½å’Œå®‰å…¨é—®é¢˜ï¼‰
          critical_checks="SA,S1,QF,ST1001,ST1005,ST1006,ST1008,ST1011,ST1012,ST1013,ST1015,ST1016,ST1017,ST1018,ST1019"
          critical_failed=false

          echo "ğŸ“‹ æ‰§è¡Œæ ¸å¿ƒè´¨é‡æ£€æŸ¥..."
          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "æ ¸å¿ƒæ£€æŸ¥ $module æ¨¡å—..."
              cd "$module" && staticcheck -checks "$critical_checks" ./... || critical_failed=true
              cd ..
            fi
          done

          # é£æ ¼æ£€æŸ¥ï¼ˆè¯¦ç»†è¾“å‡ºï¼‰
          echo ""
          echo "ğŸ“ æ£€æŸ¥ä»£ç é£æ ¼å»ºè®®..."
          style_checks="ST1000,ST1003,ST1020,ST1021,ST1023"
          style_output=""
          style_count=0

          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "é£æ ¼æ£€æŸ¥ $module æ¨¡å—..."
              module_style_output=$(cd "$module" && staticcheck -checks "$style_checks" ./... 2>/dev/null || true)
              if [ ! -z "$module_style_output" ]; then
                style_output="${style_output}${module_style_output}\n"
                module_count=$(echo "$module_style_output" | wc -l)
                style_count=$((style_count + module_count))
              fi
            fi
          done

          # ä¿å­˜é£æ ¼å»ºè®®åˆ°ç¯å¢ƒå˜é‡
          echo "STYLE_SUGGESTIONS_COUNT=$style_count" >> $GITHUB_ENV
          if [ $style_count -gt 0 ]; then
            echo "STYLE_SUGGESTIONS_FOUND=true" >> $GITHUB_ENV
            echo "STYLE_SUGGESTIONS<<EOF" >> $GITHUB_ENV
            echo -e "$style_output" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            echo "â„¹ï¸ å‘ç° $style_count ä¸ªä»£ç é£æ ¼æ”¹è¿›ç‚¹ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰"
          else
            echo "STYLE_SUGGESTIONS_FOUND=false" >> $GITHUB_ENV
            echo "STYLE_SUGGESTIONS=" >> $GITHUB_ENV
            echo "âœ¨ ä»£ç é£æ ¼å¾ˆæ£’ï¼"
          fi

          # æ£€æŸ¥æ ¸å¿ƒé—®é¢˜ç»“æœ
          if [ "$critical_failed" = "true" ]; then
            echo "âŒ staticcheck å‘ç°é‡è¦é—®é¢˜éœ€è¦ä¿®å¤"
            exit 1
          fi
          echo "âœ… staticcheck æ ¸å¿ƒæ£€æŸ¥é€šè¿‡"

      # è¿è¡Œæµ‹è¯•
      - name: Run tests
        run: |
          echo "ğŸ§ª è¿è¡Œ Go æµ‹è¯•..."
          test_failed=false

          for module in server pkg coraza-spoa; do
            if [ -d "$module" ]; then
              echo "æµ‹è¯• $module æ¨¡å—..."
              cd "$module" && go test -v -race -coverprofile=coverage.out ./... || test_failed=true
              cd ..
            fi
          done

          if [ "$test_failed" = "true" ]; then
            echo "âŒ æµ‹è¯•å¤±è´¥"
            exit 1
          fi
          echo "âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡"

      # ä½¿ç”¨å®˜æ–¹ govulncheck-action æ£€æŸ¥å®‰å…¨æ¼æ´ï¼ˆæ”¯æŒå¤šæ¨¡å—ï¼‰
      - name: Run govulncheck for server module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: server
          go-package: ./...
        continue-on-error: true

      - name: Run govulncheck for pkg module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: pkg
          go-package: ./...
        continue-on-error: true

      - name: Run govulncheck for coraza-spoa module
        if: always()
        uses: golang/govulncheck-action@v1
        with:
          work-dir: coraza-spoa
          go-package: ./...
        continue-on-error: true

      # ğŸ“¤ è®¾ç½®è¾“å‡ºçŠ¶æ€ï¼ˆä¿®å¤VS Codeè­¦å‘Šï¼‰
      - name: Set job outputs
        id: set-status
        if: always()
        run: |
          echo "format_issues=${FORMAT_ISSUES:-false}" >> $GITHUB_OUTPUT
          echo "format_files=${FORMAT_FILES:-}" >> $GITHUB_OUTPUT
          echo "style_suggestions_found=${STYLE_SUGGESTIONS_FOUND:-false}" >> $GITHUB_OUTPUT
          echo "style_suggestions_count=${STYLE_SUGGESTIONS_COUNT:-0}" >> $GITHUB_OUTPUT
          echo "style_suggestions=${STYLE_SUGGESTIONS:-}" >> $GITHUB_OUTPUT

      # ç”Ÿæˆè¯¦ç»†æ£€æŸ¥æŠ¥å‘Š
      - name: Generate Go check summary
        if: always()
        run: |
          echo "## âš¡ Go Code Quality Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # æ£€æŸ¥çŠ¶æ€
          echo "### ğŸ“‹ Core Check Results" >> $GITHUB_STEP_SUMMARY
          echo "| Check Item | Status | Description |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|------|------|" >> $GITHUB_STEP_SUMMARY

          # æ ¼å¼æ£€æŸ¥çŠ¶æ€
          if [ "$FORMAT_ISSUES" = "true" ]; then
            echo "| Code Formatting | âš ï¸ Suggestions Available | Found formatting improvement points |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Formatting | âœ… Passed | Standard formatting |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "| go vet | âœ… Passed | No important issues |" >> $GITHUB_STEP_SUMMARY
          echo "| staticcheck (core) | âœ… Passed | No bugs or security issues |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | âœ… Passed | Functionality verified |" >> $GITHUB_STEP_SUMMARY
          echo "| Security Check | âœ… Passed | Using official govulncheck-action |" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY

          # è¯¦ç»†æ”¹è¿›å»ºè®®
          if [ "$FORMAT_ISSUES" = "true" ] || [ "$STYLE_SUGGESTIONS_FOUND" = "true" ]; then
            echo "### ğŸ’¡ Optional Improvement Suggestions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FORMAT_ISSUES" = "true" ]; then
              echo "#### ğŸ¨ Code Formatting Optimization" >> $GITHUB_STEP_SUMMARY
              echo "The following files can be formatted using \`gofmt -w .\`:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$FORMAT_FILES" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi

            if [ "$STYLE_SUGGESTIONS_FOUND" = "true" ]; then
              echo "#### ğŸ“ Code Style Suggestions (${STYLE_SUGGESTIONS_COUNT} items)" >> $GITHUB_STEP_SUMMARY
              echo "The following are staticcheck style suggestions, which can be adopted based on team standards:" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$STYLE_SUGGESTIONS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi

          # ä»£ç è´¨é‡æ¦‚è§ˆ
          echo "### ğŸ“Š Code Quality Overview" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”§ Core Quality**: Passed all important checks" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ§ª Functionality Verification**: Complete test coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ”’ Security Check**: Module-wise scanning using official govulncheck-action" >> $GITHUB_STEP_SUMMARY
          echo "- **ğŸ—ï¸ Project Structure**: Complete multi-module workspace support" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š Project Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Go Version**: 1.24.1" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Strategy**: Module-wise checks (server, pkg, coraza-spoa)" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Check Time**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # ğŸ”’ å®‰å…¨çš„ PR è¯„è®º jobï¼ˆä½¿ç”¨ pull_request_targetï¼Œä½†ä¸ checkout å¤–éƒ¨ä»£ç ï¼‰
  pr-comment:
    name: PR Comment Handler
    runs-on: ubuntu-latest
    # åªåœ¨ pull_request_target äº‹ä»¶æ—¶è¿è¡Œ
    if: github.event_name == 'pull_request_target'

    steps:
      # ğŸ”’ é‡è¦ï¼šä¸ checkout ä»»ä½•ä»£ç ï¼Œç‰¹åˆ«æ˜¯ PR ä»£ç ï¼
      # ğŸ”’ åªä½¿ç”¨ GitHub API è·å–å·¥ä½œæµè¿è¡Œç»“æœ

      - name: Wait for main check to complete
        uses: actions/github-script@v7
        id: wait-for-check
        with:
          script: |
            const { owner, repo } = context.repo;
            const headSha = context.payload.pull_request.head.sha;

            console.log(`ç­‰å¾… commit ${headSha} çš„æ£€æŸ¥å®Œæˆ...`);

            // ç­‰å¾…æœ€å¤š 10 åˆ†é’Ÿ
            const maxWaitTime = 10 * 60 * 1000; // 10 minutes
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
              try {
                // è·å– commit çš„æ‰€æœ‰ check runs
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner,
                  repo,
                  ref: headSha,
                });
                
                // æŸ¥æ‰¾æˆ‘ä»¬çš„Goæ£€æŸ¥å·¥ä½œæµ
                const goCheck = checkRuns.check_runs.find(run => 
                  run.name === 'Go Code Quality Check'
                );
                
                if (goCheck) {
                  console.log(`å‘ç°æ£€æŸ¥: ${goCheck.name}, çŠ¶æ€: ${goCheck.status}`);
                  
                  if (goCheck.status === 'completed') {
                    console.log(`æ£€æŸ¥å®Œæˆï¼Œç»“è®º: ${goCheck.conclusion}`);
                    return {
                      completed: true,
                      conclusion: goCheck.conclusion,
                      details_url: goCheck.details_url
                    };
                  }
                }
                
                // ç­‰å¾… 30 ç§’åé‡è¯•
                await new Promise(resolve => setTimeout(resolve, 30000));
              } catch (error) {
                console.log(`è·å–æ£€æŸ¥çŠ¶æ€æ—¶å‡ºé”™: ${error.message}`);
                await new Promise(resolve => setTimeout(resolve, 30000));
              }
            }

            // è¶…æ—¶æƒ…å†µ
            console.log('ç­‰å¾…è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤å€¼');
            return {
              completed: false,
              conclusion: 'timed_out',
              details_url: null
            };

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const checkResult = ${{ steps.wait-for-check.outputs.result }};
            const prNumber = context.payload.pull_request.number;

            let emoji, statusEn, statusCn, conclusion;

            if (!checkResult.completed) {
              emoji = 'â°';
              statusEn = 'In Progress';
              statusCn = 'è¿›è¡Œä¸­';
              conclusion = 'pending';
            } else {
              switch(checkResult.conclusion) {
                case 'success':
                  emoji = 'âœ…';
                  statusEn = 'Passed';
                  statusCn = 'é€šè¿‡';
                  conclusion = 'success';
                  break;
                case 'failure':
                  emoji = 'âŒ';
                  statusEn = 'Failed';
                  statusCn = 'å¤±è´¥';
                  conclusion = 'failure';
                  break;
                default:
                  emoji = 'âš ï¸';
                  statusEn = 'Unknown';
                  statusCn = 'æœªçŸ¥';
                  conclusion = 'neutral';
              }
            }

            // æ„å»ºä¸­æ–‡æŠ¥å‘Š
            let chineseReport = `### ä¸­æ–‡æŠ¥å‘Š\n\n`;

            if (!checkResult.completed) {
              chineseReport += `**â° çŠ¶æ€:** Go ä»£ç è´¨é‡æ£€æŸ¥æ­£åœ¨è¿›è¡Œä¸­ï¼Œè¯·ç¨å€™æŸ¥çœ‹ç»“æœã€‚`;
            } else if (checkResult.conclusion === 'success') {
              chineseReport += `**ğŸ‰ ç»“æœ:** Go ä»£ç æ ¸å¿ƒè´¨é‡æ£€æŸ¥å…¨éƒ¨é€šè¿‡ï¼ä»£ç åŠŸèƒ½ç¨³å®šå¯é ã€‚\n\n`;
              chineseReport += `**ğŸ“‹ æ ¸å¿ƒæ£€æŸ¥é¡¹ç›®:**\n`;
              chineseReport += `- âœ… go vet é™æ€åˆ†æ\n`;
              chineseReport += `- âœ… staticcheck æ ¸å¿ƒæ£€æŸ¥ï¼ˆbug & å®‰å…¨ï¼‰\n`;
              chineseReport += `- âœ… å•å…ƒæµ‹è¯•\n`;
              chineseReport += `- âœ… å®‰å…¨æ£€æŸ¥ï¼ˆå®˜æ–¹ govulncheck-actionï¼‰\n`;
              chineseReport += `- âœ… ä»£ç æ ¼å¼æ£€æŸ¥\n\n`;
              chineseReport += `**ğŸ”§ å¤šæ¨¡å—æ”¯æŒ:** å·²åˆ†åˆ«æ£€æŸ¥ serverã€pkgã€coraza-spoa ä¸‰ä¸ªæ¨¡å—ã€‚`;
            } else if (checkResult.conclusion === 'failure') {
              chineseReport += `**âš ï¸ éœ€è¦å…³æ³¨:** å‘ç°éœ€è¦ä¿®å¤çš„é‡è¦é—®é¢˜ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—ã€‚\n\n`;
              chineseReport += `ç‚¹å‡»ä¸‹æ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†æ£€æŸ¥ç»“æœã€‚`;
            } else {
              chineseReport += `**â„¹ï¸ çŠ¶æ€:** æ£€æŸ¥çŠ¶æ€å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥å·¥ä½œæµé…ç½®ã€‚`;
            }

            // æ„å»ºè‹±æ–‡æŠ¥å‘Š
            let englishReport = `### English Report\n\n`;

            if (!checkResult.completed) {
              englishReport += `**â° Status:** Go code quality check is in progress, please wait for results.`;
            } else if (checkResult.conclusion === 'success') {
              englishReport += `**ğŸ‰ Result:** All Go code quality checks passed! Code is stable and reliable.\n\n`;
              englishReport += `**ğŸ“‹ Core Checks:**\n`;
              englishReport += `- âœ… go vet static analysis\n`;
              englishReport += `- âœ… staticcheck core checks (bugs & security)\n`;
              englishReport += `- âœ… unit tests\n`;
              englishReport += `- âœ… security scan (official govulncheck-action)\n`;
              englishReport += `- âœ… code formatting check\n\n`;
              englishReport += `**ğŸ”§ Multi-module Support:** Checked server, pkg, and coraza-spoa modules separately.`;
            } else if (checkResult.conclusion === 'failure') {
              englishReport += `**âš ï¸ Attention Required:** Important issues found that need to be fixed. Please check the detailed logs.\n\n`;
              englishReport += `Click the link below to view detailed check results.`;
            } else {
              englishReport += `**â„¹ï¸ Status:** Check status is abnormal, please check workflow configuration.`;
            }

            // ç»„åˆæœ€ç»ˆå†…å®¹
            let body = `## âš¡ Go Code Quality Check ${statusEn} ${emoji}\n\n`;
            body += `**PR #${prNumber}** Go code quality check completed.\n\n`;
            body += `${chineseReport}\n\n---\n\n${englishReport}`;

            // å¦‚æœæœ‰è¯¦ç»†é“¾æ¥ï¼Œæ·»åŠ åˆ°æŠ¥å‘Šä¸­
            if (checkResult.details_url) {
              body += `\n\n**ğŸ”— View Details:** [Click here to see the full check results](${checkResult.details_url})`;
            }

            // æŸ¥æ‰¾å¹¶æ›´æ–°ç°æœ‰è¯„è®º
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('âš¡ Go Code Quality Check')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
              console.log('å·²æ›´æ–°ç°æœ‰çš„ PR è¯„è®º');
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: body
              });
              console.log('å·²åˆ›å»ºæ–°çš„ PR è¯„è®º');
            }
