name: Release

on:
  push:
    tags:
      - "v*.*.*" # åŒ¹é… v1.0.0 æ ¼å¼çš„æ ‡ç­¾

# æ˜ç¡®å£°æ˜æ‰€éœ€çš„æœ€å°æƒé™
permissions:
  contents: write # åˆ›å»ºReleaseå’Œè®¿é—®ä»“åº“å†…å®¹
  packages: write # æ¨é€åˆ°Docker Hubï¼ˆå¯é€‰ï¼Œå¦‚æœä½¿ç”¨GitHub Package Registryï¼‰

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–æ‰€æœ‰å†å²è®°å½•ç”¨äºç”Ÿæˆ changelog

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # ä» tag ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯
      - name: Get version
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_WITHOUT_V=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "æå–çš„ç‰ˆæœ¬: $VERSION"

      # ç”Ÿæˆ Docker å…ƒæ•°æ®ï¼ˆä½¿ç”¨æ ‡å‡†åŒ–çš„æ–¹å¼ï¼‰
      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf
          tags: |
            # ç‰ˆæœ¬æ ‡ç­¾
            type=ref,event=tag
            # ä¸å¸¦vå‰ç¼€çš„ç‰ˆæœ¬
            type=match,pattern=v(.*),group=1
            # latestæ ‡ç­¾
            type=raw,value=latest
          labels: |
            org.opencontainers.image.title=RuiQi WAF
            org.opencontainers.image.description=Modern web application firewall management system
            org.opencontainers.image.version=${{ steps.get_version.outputs.VERSION }}

      # æ„å»ºå¹¶æ¨é€å¤šå¹³å°é•œåƒï¼ˆç§»é™¤å¯èƒ½æœ‰é—®é¢˜çš„arm/v7ï¼‰
      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.revision'] }}

      # æ”¹è¿›çš„ changelog ç”Ÿæˆ
      - name: Generate changelog
        id: changelog
        run: |
          echo "å¼€å§‹ç”Ÿæˆchangelog..."

          # è·å–ä¸Šä¸€ä¸ª tag
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            echo "æœªæ‰¾åˆ°ä¹‹å‰çš„tagï¼Œè¿™æ˜¯é¦–æ¬¡å‘å¸ƒ"
            # ä¸­æ–‡ç‰ˆæœ¬
            CHANGELOG_CN="ğŸ‰ é¦–æ¬¡å‘å¸ƒ

            ### âœ¨ åŠŸèƒ½ç‰¹æ€§
            - å…¨æ–°çš„RuiQi WAFç®¡ç†ç³»ç»Ÿ
            - åŸºäºHAProxyå’ŒOWASP Coraza WAF
            - æä¾›å®Œæ•´çš„åç«¯APIç”¨äºç®¡ç†é…ç½®å’Œè§„åˆ™
            - æ”¯æŒæµé‡æ£€æŸ¥å’Œå®‰å…¨é˜²æŠ¤

            ### ğŸ—ï¸ æŠ€æœ¯æ ˆ
            - å¤šæ¶æ„æ”¯æŒ (linux/amd64, linux/arm64)
            - å®¹å™¨åŒ–éƒ¨ç½²
            - ç°ä»£åŒ–çš„Webåº”ç”¨é˜²ç«å¢™"

            # è‹±æ–‡ç‰ˆæœ¬
            CHANGELOG_EN="ğŸ‰ Initial Release

            ### âœ¨ Features
            - Brand new RuiQi WAF management system
            - Based on HAProxy and OWASP Coraza WAF
            - Complete backend API for configuration and rule management
            - Traffic inspection and security protection support

            ### ğŸ—ï¸ Tech Stack
            - Multi-architecture support (linux/amd64, linux/arm64)
            - Containerized deployment
            - Modern web application firewall"
          else
            echo "ä¸Šä¸€ä¸ªtag: $PREV_TAG"
            echo "å½“å‰tag: ${{ steps.get_version.outputs.VERSION }}"
            
            # ç”Ÿæˆå˜æ›´æ—¥å¿—ï¼Œä½¿ç”¨æ›´ç®€å•çš„æ–¹å¼
            CHANGES=$(git log $PREV_TAG..${{ steps.get_version.outputs.VERSION }} --pretty=format:"- %s (%h)" --no-merges | head -20)
            
            if [ -z "$CHANGES" ]; then
              CHANGELOG_CN="æœ¬æ¬¡å‘å¸ƒåŒ…å«é”™è¯¯ä¿®å¤å’Œæ€§èƒ½æ”¹è¿›ã€‚"
              CHANGELOG_EN="This release includes bug fixes and performance improvements."
            else
              CHANGELOG_CN="### ğŸ“ æ›´æ–°å†…å®¹

            $CHANGES

            ### ğŸ”„ æ›´å¤šä¿¡æ¯
            æŸ¥çœ‹å®Œæ•´çš„æäº¤å†å²: [\`$PREV_TAG...${{ steps.get_version.outputs.VERSION }}\`](https://github.com/${{ github.repository }}/compare/$PREV_TAG...${{ steps.get_version.outputs.VERSION }})"

              CHANGELOG_EN="### ğŸ“ What's Changed

            $CHANGES

            ### ğŸ”„ More Information
            View full commit history: [\`$PREV_TAG...${{ steps.get_version.outputs.VERSION }}\`](https://github.com/${{ github.repository }}/compare/$PREV_TAG...${{ steps.get_version.outputs.VERSION }})"
            fi
          fi

          # ä½¿ç”¨ EOF æ ¼å¼å®‰å…¨åœ°è®¾ç½®å¤šè¡Œè¾“å‡º
          {
            echo 'CHANGELOG_CN<<EOF'
            echo "$CHANGELOG_CN"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          {
            echo 'CHANGELOG_EN<<EOF'
            echo "$CHANGELOG_EN"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      # åˆ›å»º GitHub Release
      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.get_version.outputs.VERSION }}
          name: "RuiQi WAF ${{ steps.get_version.outputs.VERSION }}"
          generateReleaseNotes: true
          body: |
            ## ğŸš€ RuiQi WAF ${{ steps.get_version.outputs.VERSION }} å‘å¸ƒ

            ### ä¸­æ–‡ç‰ˆæœ¬

            ### ğŸ“¦ Docker é•œåƒ

            **å¿«é€Ÿå¼€å§‹:**
            ```bash
            # æ‹‰å–æœ€æ–°ç‰ˆæœ¬
            docker pull ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:${{ steps.get_version.outputs.VERSION }}

            # æˆ–ä½¿ç”¨ latest æ ‡ç­¾
            docker pull ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:latest

            # æˆ–ä½¿ç”¨ä¸å¸¦vå‰ç¼€çš„ç‰ˆæœ¬
            docker pull ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:${{ steps.get_version.outputs.VERSION_WITHOUT_V }}
            ```

            **å¯ç”¨é•œåƒæ ‡ç­¾:**
            ${{ steps.meta.outputs.tags }}

            ### ğŸ—ï¸ æ”¯æŒçš„å¹³å°
            - `linux/amd64` - é€‚ç”¨äºå¤§å¤šæ•°æœåŠ¡å™¨å’Œå¼€å‘ç¯å¢ƒ
            - `linux/arm64` - é€‚ç”¨äºARM64æ¶æ„ï¼ˆå¦‚Apple Siliconã€AWS Gravitonç­‰ï¼‰

            ### ğŸ“ æ›´æ–°æ—¥å¿—
            ${{ steps.changelog.outputs.CHANGELOG_CN }}

            ### ğŸ“š æ–‡æ¡£å’Œæ”¯æŒ
            - [é¡¹ç›®æ–‡æ¡£](https://github.com/${{ github.repository }})
            - [å®‰è£…æŒ‡å—](https://github.com/${{ github.repository }}#installation)
            - [é—®é¢˜åé¦ˆ](https://github.com/${{ github.repository }}/issues)

            ### ğŸ” å®‰å…¨ä¿¡æ¯
            - é•œåƒä½¿ç”¨å¤šé˜¶æ®µæ„å»ºï¼Œå‡å°‘æ”»å‡»é¢
            - æ”¯æŒç°ä»£å®¹å™¨å®‰å…¨æœ€ä½³å®è·µ
            - å®šæœŸæ›´æ–°åŸºç¡€é•œåƒä»¥ä¿®å¤å®‰å…¨æ¼æ´

            ---

            ### English Version

            ### ğŸ“¦ Docker Images

            **Quick Start:**
            ```bash
            # Pull latest version
            docker pull ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:${{ steps.get_version.outputs.VERSION }}

            # Or use latest tag
            docker pull ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:latest

            # Or use version without v prefix
            docker pull ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:${{ steps.get_version.outputs.VERSION_WITHOUT_V }}
            ```

            **Available Image Tags:**
            ${{ steps.meta.outputs.tags }}

            ### ğŸ—ï¸ Supported Platforms
            - `linux/amd64` - For most servers and development environments
            - `linux/arm64` - For ARM64 architecture (Apple Silicon, AWS Graviton, etc.)

            ### ğŸ“ Changelog
            ${{ steps.changelog.outputs.CHANGELOG_EN }}

            ### ğŸ“š Documentation and Support
            - [Project Documentation](https://github.com/${{ github.repository }})
            - [Installation Guide](https://github.com/${{ github.repository }}#installation)
            - [Issue Tracking](https://github.com/${{ github.repository }}/issues)

            ### ğŸ” Security Information
            - Images use multi-stage builds to reduce attack surface
            - Supports modern container security best practices
            - Base images are regularly updated to fix security vulnerabilities

            ---

            **Full Changelog:** [\`${{ steps.get_version.outputs.VERSION }}\`](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }})
          draft: false
          prerelease: false
          makeLatest: true
          allowUpdates: false

      # æ·»åŠ å‘å¸ƒåçš„é€šçŸ¥
      - name: Post-release summary
        run: |
          echo "## ğŸ‰ Release Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### ä¸­æ–‡ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç‰ˆæœ¬:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dockeré•œåƒ:** ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**å‘å¸ƒé¡µé¢:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**æ”¯æŒçš„å¹³å°:**" >> $GITHUB_STEP_SUMMARY
          echo "- linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### English Version" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Docker Image:** ${{ vars.DOCKERHUB_USERNAME }}/ruiqi-waf:${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Page:** ${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Supported Platforms:**" >> $GITHUB_STEP_SUMMARY
          echo "- linux/amd64" >> $GITHUB_STEP_SUMMARY
          echo "- linux/arm64" >> $GITHUB_STEP_SUMMARY
